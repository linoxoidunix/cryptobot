\hypertarget{fmtlog-inl_8h_source}{}\doxysection{fmtlog-\/inl.h}
\label{fmtlog-inl_8h_source}\index{/home/linoxoidunix/Programming/cplusplus/cryptobot/bybit/third\_party/fmtlog-\/inl.h@{/home/linoxoidunix/Programming/cplusplus/cryptobot/bybit/third\_party/fmtlog-\/inl.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{MIT License}}
\DoxyCodeLine{3 \textcolor{comment}{}}
\DoxyCodeLine{4 \textcolor{comment}{Copyright (c) 2021 Meng Rao <raomeng1@gmail.com>}}
\DoxyCodeLine{5 \textcolor{comment}{}}
\DoxyCodeLine{6 \textcolor{comment}{Permission is hereby granted, free of charge, to any person obtaining a copy}}
\DoxyCodeLine{7 \textcolor{comment}{of this software and associated documentation files (the "{}Software"{}), to deal}}
\DoxyCodeLine{8 \textcolor{comment}{in the Software without restriction, including without limitation the rights}}
\DoxyCodeLine{9 \textcolor{comment}{to use, copy, modify, merge, publish, distribute, sublicense, and/or sell}}
\DoxyCodeLine{10 \textcolor{comment}{copies of the Software, and to permit persons to whom the Software is}}
\DoxyCodeLine{11 \textcolor{comment}{furnished to do so, subject to the following conditions:}}
\DoxyCodeLine{12 \textcolor{comment}{}}
\DoxyCodeLine{13 \textcolor{comment}{The above copyright notice and this permission notice shall be included in all}}
\DoxyCodeLine{14 \textcolor{comment}{copies or substantial portions of the Software.}}
\DoxyCodeLine{15 \textcolor{comment}{}}
\DoxyCodeLine{16 \textcolor{comment}{THE SOFTWARE IS PROVIDED "{}AS IS"{}, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR}}
\DoxyCodeLine{17 \textcolor{comment}{IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,}}
\DoxyCodeLine{18 \textcolor{comment}{FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE}}
\DoxyCodeLine{19 \textcolor{comment}{AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER}}
\DoxyCodeLine{20 \textcolor{comment}{LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,}}
\DoxyCodeLine{21 \textcolor{comment}{OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE}}
\DoxyCodeLine{22 \textcolor{comment}{SOFTWARE.}}
\DoxyCodeLine{23 \textcolor{comment}{*/}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include "{}fmtlog.h"{}}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include <mutex>}}
\DoxyCodeLine{26 \textcolor{preprocessor}{\#include <thread>}}
\DoxyCodeLine{27 \textcolor{preprocessor}{\#include <limits>}}
\DoxyCodeLine{28 \textcolor{preprocessor}{\#include <ios>}}
\DoxyCodeLine{29 }
\DoxyCodeLine{30 \textcolor{preprocessor}{\#ifdef \_WIN32}}
\DoxyCodeLine{31 \textcolor{preprocessor}{\#ifndef NOMINMAX}}
\DoxyCodeLine{32 \textcolor{preprocessor}{\#define NOMINMAX}}
\DoxyCodeLine{33 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{34 \textcolor{preprocessor}{\#include <windows.h>}}
\DoxyCodeLine{35 \textcolor{preprocessor}{\#include <processthreadsapi.h>}}
\DoxyCodeLine{36 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{37 \textcolor{preprocessor}{\#include <sys/syscall.h>}}
\DoxyCodeLine{38 \textcolor{preprocessor}{\#include <unistd.h>}}
\DoxyCodeLine{39 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{40 }
\DoxyCodeLine{41 \textcolor{keyword}{namespace }\{}
\DoxyCodeLine{42 \textcolor{keywordtype}{void} fmtlogEmptyFun(\textcolor{keywordtype}{void}*) \{}
\DoxyCodeLine{43 \}}
\DoxyCodeLine{44 \} \textcolor{comment}{// namespace}}
\DoxyCodeLine{45 }
\DoxyCodeLine{46 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_\_\_ = 0>}
\DoxyCodeLine{47 \textcolor{keyword}{class }\mbox{\hyperlink{classfmtlogDetailT}{fmtlogDetailT}}}
\DoxyCodeLine{48 \{}
\DoxyCodeLine{49 \textcolor{keyword}{public}:}
\DoxyCodeLine{50   \textcolor{comment}{// https://github.com/MengRao/str}}
\DoxyCodeLine{51   \textcolor{keyword}{template}<\textcolor{keywordtype}{size\_t} SIZE>}
\DoxyCodeLine{52   \textcolor{keyword}{class }\mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str}}}
\DoxyCodeLine{53   \{}
\DoxyCodeLine{54   \textcolor{keyword}{public}:}
\DoxyCodeLine{55     \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{int} Size = SIZE;}
\DoxyCodeLine{56     \textcolor{keywordtype}{char} s[SIZE];}
\DoxyCodeLine{57 }
\DoxyCodeLine{58     \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str}}() \{\}}
\DoxyCodeLine{59     \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* p) \{ *\textcolor{keyword}{this} = *(\textcolor{keyword}{const} \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<SIZE>}}*)p; \}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61     \textcolor{keywordtype}{char}\& operator[](\textcolor{keywordtype}{int} i) \{ \textcolor{keywordflow}{return} s[i]; \}}
\DoxyCodeLine{62     \textcolor{keywordtype}{char} operator[](\textcolor{keywordtype}{int} i)\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} s[i]; \}}
\DoxyCodeLine{63 }
\DoxyCodeLine{64     \textcolor{keyword}{template}<\textcolor{keyword}{typename} T>}
\DoxyCodeLine{65     \textcolor{keywordtype}{void} fromi(T num) \{}
\DoxyCodeLine{66       \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (Size \& 1) \{}
\DoxyCodeLine{67         s[Size -\/ 1] = \textcolor{charliteral}{'0'} + (num \% 10);}
\DoxyCodeLine{68         num /= 10;}
\DoxyCodeLine{69       \}}
\DoxyCodeLine{70       \textcolor{keywordflow}{switch} (Size \& -\/2) \{}
\DoxyCodeLine{71         \textcolor{keywordflow}{case} 18: *(uint16\_t*)(s + 16) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{72         \textcolor{keywordflow}{case} 16: *(uint16\_t*)(s + 14) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{73         \textcolor{keywordflow}{case} 14: *(uint16\_t*)(s + 12) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{74         \textcolor{keywordflow}{case} 12: *(uint16\_t*)(s + 10) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{75         \textcolor{keywordflow}{case} 10: *(uint16\_t*)(s + 8) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{76         \textcolor{keywordflow}{case} 8: *(uint16\_t*)(s + 6) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{77         \textcolor{keywordflow}{case} 6: *(uint16\_t*)(s + 4) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{78         \textcolor{keywordflow}{case} 4: *(uint16\_t*)(s + 2) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{79         \textcolor{keywordflow}{case} 2: *(uint16\_t*)(s + 0) = *(uint16\_t*)(digit\_pairs + ((num \% 100) << 1)); num /= 100;}
\DoxyCodeLine{80       \}}
\DoxyCodeLine{81     \}}
\DoxyCodeLine{82 }
\DoxyCodeLine{83     \textcolor{keyword}{static} \textcolor{keyword}{constexpr} \textcolor{keyword}{const} \textcolor{keywordtype}{char}* digit\_pairs = \textcolor{stringliteral}{"{}00010203040506070809"{}}}
\DoxyCodeLine{84                                                \textcolor{stringliteral}{"{}10111213141516171819"{}}}
\DoxyCodeLine{85                                                \textcolor{stringliteral}{"{}20212223242526272829"{}}}
\DoxyCodeLine{86                                                \textcolor{stringliteral}{"{}30313233343536373839"{}}}
\DoxyCodeLine{87                                                \textcolor{stringliteral}{"{}40414243444546474849"{}}}
\DoxyCodeLine{88                                                \textcolor{stringliteral}{"{}50515253545556575859"{}}}
\DoxyCodeLine{89                                                \textcolor{stringliteral}{"{}60616263646566676869"{}}}
\DoxyCodeLine{90                                                \textcolor{stringliteral}{"{}70717273747576777879"{}}}
\DoxyCodeLine{91                                                \textcolor{stringliteral}{"{}80818283848586878889"{}}}
\DoxyCodeLine{92                                                \textcolor{stringliteral}{"{}90919293949596979899"{}};}
\DoxyCodeLine{93   \};}
\DoxyCodeLine{94 }
\DoxyCodeLine{95   \mbox{\hyperlink{classfmtlogDetailT}{fmtlogDetailT}}()}
\DoxyCodeLine{96     : flushDelay(3000000000) \{}
\DoxyCodeLine{97     args.reserve(4096);}
\DoxyCodeLine{98     args.resize(parttenArgSize);}
\DoxyCodeLine{99 }
\DoxyCodeLine{100     \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.init();}
\DoxyCodeLine{101     resetDate();}
\DoxyCodeLine{102     fmtlog::setLogFile(stdout);}
\DoxyCodeLine{103     setHeaderPattern(\textcolor{stringliteral}{"{}\{HMSf\} \{s:<16\} \{l\}[\{t:<6\}] "{}});}
\DoxyCodeLine{104     logInfos.reserve(32);}
\DoxyCodeLine{105     bgLogInfos.reserve(128);}
\DoxyCodeLine{106     bgLogInfos.emplace\_back(\textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}, fmtlog::DBG, fmt::string\_view());}
\DoxyCodeLine{107     bgLogInfos.emplace\_back(\textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}, fmtlog::INF, fmt::string\_view());}
\DoxyCodeLine{108     bgLogInfos.emplace\_back(\textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}, fmtlog::WRN, fmt::string\_view());}
\DoxyCodeLine{109     bgLogInfos.emplace\_back(\textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}, fmtlog::ERR, fmt::string\_view());}
\DoxyCodeLine{110     threadBuffers.reserve(8);}
\DoxyCodeLine{111     bgThreadBuffers.reserve(8);}
\DoxyCodeLine{112     memset(membuf.data(), 0, membuf.capacity());}
\DoxyCodeLine{113   \}}
\DoxyCodeLine{114 }
\DoxyCodeLine{115   \mbox{\hyperlink{classfmtlogDetailT}{\string~fmtlogDetailT}}() \{}
\DoxyCodeLine{116     stopPollingThread();}
\DoxyCodeLine{117     poll(\textcolor{keyword}{true});}
\DoxyCodeLine{118     closeLogFile();}
\DoxyCodeLine{119   \}}
\DoxyCodeLine{120 }
\DoxyCodeLine{121   \textcolor{keywordtype}{void} setHeaderPattern(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* pattern) \{}
\DoxyCodeLine{122     \textcolor{keywordflow}{if} (shouldDeallocateHeader) \textcolor{keyword}{delete}[] headerPattern.data();}
\DoxyCodeLine{123     \textcolor{keyword}{using namespace }fmt::literals;}
\DoxyCodeLine{124     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < parttenArgSize; i++) \{}
\DoxyCodeLine{125       reorderIdx[i] = parttenArgSize -\/ 1;}
\DoxyCodeLine{126     \}}
\DoxyCodeLine{127     headerPattern = fmtlog::unNameFormat<true>(}
\DoxyCodeLine{128       pattern, reorderIdx, \textcolor{stringliteral}{"{}a"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}b"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}C"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}Y"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}m"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}d"{}}\_a = \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{129       \textcolor{stringliteral}{"{}t"{}}\_a = \textcolor{stringliteral}{"{}thread name"{}}, \textcolor{stringliteral}{"{}F"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}f"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}e"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}S"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}M"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}H"{}}\_a = \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{130       \textcolor{stringliteral}{"{}l"{}}\_a = fmtlog::LogLevel(), \textcolor{stringliteral}{"{}s"{}}\_a = \textcolor{stringliteral}{"{}fmtlog.cc:123"{}}, \textcolor{stringliteral}{"{}g"{}}\_a = \textcolor{stringliteral}{"{}/home/raomeng/fmtlog/fmtlog.cc:123"{}}, \textcolor{stringliteral}{"{}Ymd"{}}\_a = \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{131       \textcolor{stringliteral}{"{}HMS"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}HMSe"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}HMSf"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}HMSF"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}YmdHMS"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}YmdHMSe"{}}\_a = \textcolor{stringliteral}{"{}"{}}, \textcolor{stringliteral}{"{}YmdHMSf"{}}\_a = \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{132       \textcolor{stringliteral}{"{}YmdHMSF"{}}\_a = \textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{133     shouldDeallocateHeader = headerPattern.data() != pattern;}
\DoxyCodeLine{134 }
\DoxyCodeLine{135     setArg<0>(fmt::string\_view(weekdayName.s, 3));}
\DoxyCodeLine{136     setArg<1>(fmt::string\_view(monthName.s, 3));}
\DoxyCodeLine{137     setArg<2>(fmt::string\_view(\&year[2], 2));}
\DoxyCodeLine{138     setArg<3>(fmt::string\_view(year.s, 4));}
\DoxyCodeLine{139     setArg<4>(fmt::string\_view(month.s, 2));}
\DoxyCodeLine{140     setArg<5>(fmt::string\_view(day.s, 2));}
\DoxyCodeLine{141     setArg<6>(fmt::string\_view());}
\DoxyCodeLine{142     setArg<7>(fmt::string\_view(nanosecond.s, 9));}
\DoxyCodeLine{143     setArg<8>(fmt::string\_view(nanosecond.s, 6));}
\DoxyCodeLine{144     setArg<9>(fmt::string\_view(nanosecond.s, 3));}
\DoxyCodeLine{145     setArg<10>(fmt::string\_view(second.s, 2));}
\DoxyCodeLine{146     setArg<11>(fmt::string\_view(minute.s, 2));}
\DoxyCodeLine{147     setArg<12>(fmt::string\_view(hour.s, 2));}
\DoxyCodeLine{148     setArg<13>(fmt::string\_view(logLevel.s, 3));}
\DoxyCodeLine{149     setArg<14>(fmt::string\_view());}
\DoxyCodeLine{150     setArg<15>(fmt::string\_view());}
\DoxyCodeLine{151     setArg<16>(fmt::string\_view(year.s, 10)); \textcolor{comment}{// Ymd}}
\DoxyCodeLine{152     setArg<17>(fmt::string\_view(hour.s, 8));  \textcolor{comment}{// HMS}}
\DoxyCodeLine{153     setArg<18>(fmt::string\_view(hour.s, 12)); \textcolor{comment}{// HMSe}}
\DoxyCodeLine{154     setArg<19>(fmt::string\_view(hour.s, 15)); \textcolor{comment}{// HMSf}}
\DoxyCodeLine{155     setArg<20>(fmt::string\_view(hour.s, 18)); \textcolor{comment}{// HMSF}}
\DoxyCodeLine{156     setArg<21>(fmt::string\_view(year.s, 19));   \textcolor{comment}{// YmdHMS}}
\DoxyCodeLine{157     setArg<22>(fmt::string\_view(year.s, 23));   \textcolor{comment}{// YmdHMSe}}
\DoxyCodeLine{158     setArg<23>(fmt::string\_view(year.s, 26));   \textcolor{comment}{// YmdHMSf}}
\DoxyCodeLine{159     setArg<24>(fmt::string\_view(year.s, 29));   \textcolor{comment}{// YmdHMSF}}
\DoxyCodeLine{160   \}}
\DoxyCodeLine{161 }
\DoxyCodeLine{162   \textcolor{keyword}{class }\mbox{\hyperlink{classfmtlogDetailT_1_1ThreadBufferDestroyer}{ThreadBufferDestroyer}}}
\DoxyCodeLine{163   \{}
\DoxyCodeLine{164   \textcolor{keyword}{public}:}
\DoxyCodeLine{165     \textcolor{keyword}{explicit} \mbox{\hyperlink{classfmtlogDetailT_1_1ThreadBufferDestroyer}{ThreadBufferDestroyer}}() \{\}}
\DoxyCodeLine{166 }
\DoxyCodeLine{167     \textcolor{keywordtype}{void} threadBufferCreated() \{\}}
\DoxyCodeLine{168 }
\DoxyCodeLine{169     \mbox{\hyperlink{classfmtlogDetailT_1_1ThreadBufferDestroyer}{\string~ThreadBufferDestroyer}}() \{}
\DoxyCodeLine{170       \textcolor{keywordflow}{if} (fmtlog::threadBuffer != \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{171         fmtlog::threadBuffer-\/>shouldDeallocate = \textcolor{keyword}{true};}
\DoxyCodeLine{172         fmtlog::threadBuffer = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{173       \}}
\DoxyCodeLine{174     \}}
\DoxyCodeLine{175   \};}
\DoxyCodeLine{176 }
\DoxyCodeLine{177   \textcolor{keyword}{struct }\mbox{\hyperlink{structfmtlogDetailT_1_1StaticLogInfo}{StaticLogInfo}}}
\DoxyCodeLine{178   \{}
\DoxyCodeLine{179     \textcolor{comment}{// Constructor}}
\DoxyCodeLine{180     \textcolor{keyword}{constexpr} \mbox{\hyperlink{structfmtlogDetailT_1_1StaticLogInfo}{StaticLogInfo}}(fmtlog::FormatToFn fn, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* loc, fmtlog::LogLevel level, fmt::string\_view fmtString)}
\DoxyCodeLine{181       : formatToFn(fn)}
\DoxyCodeLine{182       , formatString(fmtString)}
\DoxyCodeLine{183       , location(loc)}
\DoxyCodeLine{184       , logLevel(level)}
\DoxyCodeLine{185       , argIdx(-\/1) \{\}}
\DoxyCodeLine{186 }
\DoxyCodeLine{187     \textcolor{keywordtype}{void} processLocation() \{}
\DoxyCodeLine{188       \textcolor{keywordtype}{size\_t} size = strlen(location);}
\DoxyCodeLine{189       \textcolor{keyword}{const} \textcolor{keywordtype}{char}* p = location + size;}
\DoxyCodeLine{190       \textcolor{keywordflow}{if} (size > 255) \{}
\DoxyCodeLine{191         location = p -\/ 255;}
\DoxyCodeLine{192       \}}
\DoxyCodeLine{193       endPos = p -\/ location;}
\DoxyCodeLine{194       \textcolor{keyword}{const} \textcolor{keywordtype}{char}* base = location;}
\DoxyCodeLine{195       \textcolor{keywordflow}{while} (p > location) \{}
\DoxyCodeLine{196         \textcolor{keywordtype}{char} c = *-\/-\/p;}
\DoxyCodeLine{197         \textcolor{keywordflow}{if} (c == \textcolor{charliteral}{'/'} || c == \textcolor{charliteral}{'\(\backslash\)\(\backslash\)'}) \{}
\DoxyCodeLine{198           base = p + 1;}
\DoxyCodeLine{199           \textcolor{keywordflow}{break};}
\DoxyCodeLine{200         \}}
\DoxyCodeLine{201       \}}
\DoxyCodeLine{202       basePos = base -\/ location;}
\DoxyCodeLine{203     \}}
\DoxyCodeLine{204 }
\DoxyCodeLine{205     \textcolor{keyword}{inline} fmt::string\_view getBase() \{ \textcolor{keywordflow}{return} fmt::string\_view(location + basePos, endPos -\/ basePos); \}}
\DoxyCodeLine{206 }
\DoxyCodeLine{207     \textcolor{keyword}{inline} fmt::string\_view getLocation() \{ \textcolor{keywordflow}{return} fmt::string\_view(location, endPos); \}}
\DoxyCodeLine{208 }
\DoxyCodeLine{209     fmtlog::FormatToFn formatToFn;}
\DoxyCodeLine{210     fmt::string\_view formatString;}
\DoxyCodeLine{211     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* location;}
\DoxyCodeLine{212     uint8\_t basePos;}
\DoxyCodeLine{213     uint8\_t endPos;}
\DoxyCodeLine{214     fmtlog::LogLevel logLevel;}
\DoxyCodeLine{215     \textcolor{keywordtype}{int} argIdx;}
\DoxyCodeLine{216   \};}
\DoxyCodeLine{217 }
\DoxyCodeLine{218   \textcolor{keyword}{static} \textcolor{keyword}{thread\_local} \mbox{\hyperlink{classfmtlogDetailT_1_1ThreadBufferDestroyer}{ThreadBufferDestroyer}} sbc;}
\DoxyCodeLine{219   int64\_t midnightNs;}
\DoxyCodeLine{220   fmt::string\_view headerPattern;}
\DoxyCodeLine{221   \textcolor{keywordtype}{bool} shouldDeallocateHeader = \textcolor{keyword}{false};}
\DoxyCodeLine{222   FILE* outputFp = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{223   \textcolor{keywordtype}{bool} manageFp = \textcolor{keyword}{false};}
\DoxyCodeLine{224   \textcolor{keywordtype}{size\_t} fpos = 0; \textcolor{comment}{// file position of membuf, used only when manageFp == true}}
\DoxyCodeLine{225   int64\_t flushDelay;}
\DoxyCodeLine{226   int64\_t nextFlushTime = (std::numeric\_limits<int64\_t>::max)();}
\DoxyCodeLine{227   uint32\_t flushBufSize = 8 * 1024;}
\DoxyCodeLine{228   fmtlog::LogLevel flushLogLevel = fmtlog::OFF;}
\DoxyCodeLine{229   std::mutex bufferMutex;}
\DoxyCodeLine{230   std::vector<fmtlog::ThreadBuffer*> threadBuffers;}
\DoxyCodeLine{231   \textcolor{keyword}{struct }\mbox{\hyperlink{structfmtlogDetailT_1_1HeapNode}{HeapNode}}}
\DoxyCodeLine{232   \{}
\DoxyCodeLine{233     \mbox{\hyperlink{structfmtlogDetailT_1_1HeapNode}{HeapNode}}(\mbox{\hyperlink{structfmtlogT_1_1ThreadBuffer}{fmtlog::ThreadBuffer}}* buffer)}
\DoxyCodeLine{234       : tb(buffer) \{\}}
\DoxyCodeLine{235 }
\DoxyCodeLine{236     \mbox{\hyperlink{structfmtlogT_1_1ThreadBuffer}{fmtlog::ThreadBuffer}}* tb;}
\DoxyCodeLine{237     \textcolor{keyword}{const} fmtlog::SPSCVarQueueOPT::MsgHeader* header = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{238   \};}
\DoxyCodeLine{239   std::vector<HeapNode> bgThreadBuffers;}
\DoxyCodeLine{240   std::mutex logInfoMutex;}
\DoxyCodeLine{241   std::vector<StaticLogInfo> logInfos;}
\DoxyCodeLine{242   std::vector<StaticLogInfo> bgLogInfos;}
\DoxyCodeLine{243 }
\DoxyCodeLine{244   fmtlog::LogCBFn logCB = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{245   fmtlog::LogLevel minCBLogLevel;}
\DoxyCodeLine{246   fmtlog::LogQFullCBFn logQFullCB = fmtlogEmptyFun;}
\DoxyCodeLine{247   \textcolor{keywordtype}{void}* logQFullCBArg = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{248 }
\DoxyCodeLine{249   fmtlog::MemoryBuffer membuf;}
\DoxyCodeLine{250 }
\DoxyCodeLine{251   \textcolor{keyword}{const} \textcolor{keyword}{static} \textcolor{keywordtype}{int} parttenArgSize = 25;}
\DoxyCodeLine{252   uint32\_t reorderIdx[parttenArgSize];}
\DoxyCodeLine{253   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<3>}} weekdayName;}
\DoxyCodeLine{254   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<3>}} monthName;}
\DoxyCodeLine{255   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<4>}} year;}
\DoxyCodeLine{256   \textcolor{keywordtype}{char} dash1 = \textcolor{charliteral}{'-\/'};}
\DoxyCodeLine{257   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<2>}} month;}
\DoxyCodeLine{258   \textcolor{keywordtype}{char} dash2 = \textcolor{charliteral}{'-\/'};}
\DoxyCodeLine{259   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<2>}} day;}
\DoxyCodeLine{260   \textcolor{keywordtype}{char} space = \textcolor{charliteral}{' '};}
\DoxyCodeLine{261   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<2>}} hour;}
\DoxyCodeLine{262   \textcolor{keywordtype}{char} colon1 = \textcolor{charliteral}{':'};}
\DoxyCodeLine{263   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<2>}} minute;}
\DoxyCodeLine{264   \textcolor{keywordtype}{char} colon2 = \textcolor{charliteral}{':'};}
\DoxyCodeLine{265   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<2>}} second;}
\DoxyCodeLine{266   \textcolor{keywordtype}{char} dot1 = \textcolor{charliteral}{'.'};}
\DoxyCodeLine{267   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<9>}} nanosecond;}
\DoxyCodeLine{268   \mbox{\hyperlink{classfmtlogDetailT_1_1Str}{Str<3>}} logLevel;}
\DoxyCodeLine{269   std::vector<fmt::basic\_format\_arg<fmtlog::Context>> args;}
\DoxyCodeLine{270 }
\DoxyCodeLine{271   \textcolor{keyword}{volatile} \textcolor{keywordtype}{bool} threadRunning = \textcolor{keyword}{false};}
\DoxyCodeLine{272   std::thread thr;}
\DoxyCodeLine{273 }
\DoxyCodeLine{274   \textcolor{keywordtype}{void} resetDate() \{}
\DoxyCodeLine{275     time\_t rawtime = \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.tscns.rdns() / 1000000000;}
\DoxyCodeLine{276     \textcolor{keyword}{struct }tm* timeinfo = localtime(\&rawtime);}
\DoxyCodeLine{277     timeinfo-\/>tm\_sec = timeinfo-\/>tm\_min = timeinfo-\/>tm\_hour = 0;}
\DoxyCodeLine{278     midnightNs = mktime(timeinfo) * 1000000000;}
\DoxyCodeLine{279     year.fromi(1900 + timeinfo-\/>tm\_year);}
\DoxyCodeLine{280     month.fromi(1 + timeinfo-\/>tm\_mon);}
\DoxyCodeLine{281     day.fromi(timeinfo-\/>tm\_mday);}
\DoxyCodeLine{282     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* weekdays[7] = \{\textcolor{stringliteral}{"{}Sun"{}}, \textcolor{stringliteral}{"{}Mon"{}}, \textcolor{stringliteral}{"{}Tue"{}}, \textcolor{stringliteral}{"{}Wed"{}}, \textcolor{stringliteral}{"{}Thu"{}}, \textcolor{stringliteral}{"{}Fri"{}}, \textcolor{stringliteral}{"{}Sat"{}}\};}
\DoxyCodeLine{283     weekdayName = weekdays[timeinfo-\/>tm\_wday];}
\DoxyCodeLine{284     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* monthNames[12] = \{\textcolor{stringliteral}{"{}Jan"{}}, \textcolor{stringliteral}{"{}Feb"{}}, \textcolor{stringliteral}{"{}Mar"{}}, \textcolor{stringliteral}{"{}Apr"{}}, \textcolor{stringliteral}{"{}May"{}}, \textcolor{stringliteral}{"{}Jun"{}}, \textcolor{stringliteral}{"{}Jul"{}}, \textcolor{stringliteral}{"{}Aug"{}}, \textcolor{stringliteral}{"{}Sep"{}}, \textcolor{stringliteral}{"{}Oct"{}}, \textcolor{stringliteral}{"{}Nov"{}}, \textcolor{stringliteral}{"{}Dec"{}}\};}
\DoxyCodeLine{285     monthName = monthNames[timeinfo-\/>tm\_mon];}
\DoxyCodeLine{286   \}}
\DoxyCodeLine{287 }
\DoxyCodeLine{288   \textcolor{keywordtype}{void} preallocate() \{}
\DoxyCodeLine{289     \textcolor{keywordflow}{if} (fmtlog::threadBuffer) \textcolor{keywordflow}{return};}
\DoxyCodeLine{290     fmtlog::threadBuffer = \textcolor{keyword}{new} \mbox{\hyperlink{structfmtlogT_1_1ThreadBuffer}{fmtlog::ThreadBuffer}}();}
\DoxyCodeLine{291 \textcolor{preprocessor}{\#ifdef \_WIN32}}
\DoxyCodeLine{292     uint32\_t tid = \textcolor{keyword}{static\_cast<}uint32\_t\textcolor{keyword}{>}(::GetCurrentThreadId());}
\DoxyCodeLine{293 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{294     uint32\_t tid = \textcolor{keyword}{static\_cast<}uint32\_t\textcolor{keyword}{>}(::syscall(SYS\_gettid));}
\DoxyCodeLine{295 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{296     fmtlog::threadBuffer-\/>nameSize =}
\DoxyCodeLine{297       fmt::format\_to\_n(fmtlog::threadBuffer-\/>name, \textcolor{keyword}{sizeof}(fmtlog::threadBuffer-\/>name), \textcolor{stringliteral}{"{}\{\}"{}}, tid).size;}
\DoxyCodeLine{298     sbc.threadBufferCreated();}
\DoxyCodeLine{299 }
\DoxyCodeLine{300     std::unique\_lock<std::mutex> guard(bufferMutex);}
\DoxyCodeLine{301     threadBuffers.push\_back(fmtlog::threadBuffer);}
\DoxyCodeLine{302   \}}
\DoxyCodeLine{303 }
\DoxyCodeLine{304   \textcolor{keyword}{template}<\textcolor{keywordtype}{size\_t} I, \textcolor{keyword}{typename} T>}
\DoxyCodeLine{305   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} setArg(\textcolor{keyword}{const} T\& arg) \{}
\DoxyCodeLine{306     args[reorderIdx[I]] = fmt::detail::make\_arg<fmtlog::Context>(arg);}
\DoxyCodeLine{307   \}}
\DoxyCodeLine{308 }
\DoxyCodeLine{309   \textcolor{keyword}{template}<\textcolor{keywordtype}{size\_t} I, \textcolor{keyword}{typename} T>}
\DoxyCodeLine{310   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} setArgVal(\textcolor{keyword}{const} T\& arg) \{}
\DoxyCodeLine{311     fmt::detail::value<fmtlog::Context>\& value\_ = *(fmt::detail::value<fmtlog::Context>*)\&args[reorderIdx[I]];}
\DoxyCodeLine{312     value\_ = fmt::detail::arg\_mapper<fmtlog::Context>().map(arg);}
\DoxyCodeLine{313   \}}
\DoxyCodeLine{314 }
\DoxyCodeLine{315   \textcolor{keywordtype}{void} flushLogFile() \{}
\DoxyCodeLine{316     \textcolor{keywordflow}{if} (outputFp) \{}
\DoxyCodeLine{317       fwrite(membuf.data(), 1, membuf.size(), outputFp);}
\DoxyCodeLine{318       \textcolor{keywordflow}{if} (!manageFp) fflush(outputFp);}
\DoxyCodeLine{319       \textcolor{keywordflow}{else}}
\DoxyCodeLine{320         fpos += membuf.size();}
\DoxyCodeLine{321     \}}
\DoxyCodeLine{322     membuf.clear();}
\DoxyCodeLine{323     nextFlushTime = (std::numeric\_limits<int64\_t>::max)();}
\DoxyCodeLine{324   \}}
\DoxyCodeLine{325 }
\DoxyCodeLine{326   \textcolor{keywordtype}{void} closeLogFile() \{}
\DoxyCodeLine{327     \textcolor{keywordflow}{if} (membuf.size()) flushLogFile();}
\DoxyCodeLine{328     \textcolor{keywordflow}{if} (manageFp) fclose(outputFp);}
\DoxyCodeLine{329     outputFp = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{330     manageFp = \textcolor{keyword}{false};}
\DoxyCodeLine{331   \}}
\DoxyCodeLine{332 }
\DoxyCodeLine{333   \textcolor{keywordtype}{void} startPollingThread(int64\_t pollInterval) \{}
\DoxyCodeLine{334     stopPollingThread();}
\DoxyCodeLine{335     threadRunning = \textcolor{keyword}{true};}
\DoxyCodeLine{336     thr = std::thread([pollInterval, \textcolor{keyword}{this}]() \{}
\DoxyCodeLine{337       \textcolor{keywordflow}{while} (threadRunning) \{}
\DoxyCodeLine{338         int64\_t before = \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.tscns.rdns();}
\DoxyCodeLine{339         poll(\textcolor{keyword}{false});}
\DoxyCodeLine{340         int64\_t delay = \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.tscns.rdns() -\/ before;}
\DoxyCodeLine{341         \textcolor{keywordflow}{if} (delay < pollInterval) \{}
\DoxyCodeLine{342           std::this\_thread::sleep\_for(std::chrono::nanoseconds(pollInterval -\/ delay));}
\DoxyCodeLine{343         \}}
\DoxyCodeLine{344       \}}
\DoxyCodeLine{345       poll(\textcolor{keyword}{true});}
\DoxyCodeLine{346     \});}
\DoxyCodeLine{347   \}}
\DoxyCodeLine{348 }
\DoxyCodeLine{349   \textcolor{keywordtype}{void} stopPollingThread() \{}
\DoxyCodeLine{350     \textcolor{keywordflow}{if} (!threadRunning) \textcolor{keywordflow}{return};}
\DoxyCodeLine{351     threadRunning = \textcolor{keyword}{false};}
\DoxyCodeLine{352     \textcolor{keywordflow}{if} (thr.joinable()) thr.join();}
\DoxyCodeLine{353   \}}
\DoxyCodeLine{354 }
\DoxyCodeLine{355   \textcolor{keywordtype}{void} handleLog(fmt::string\_view threadName, \textcolor{keyword}{const} fmtlog::SPSCVarQueueOPT::MsgHeader* header) \{}
\DoxyCodeLine{356     setArgVal<6>(threadName);}
\DoxyCodeLine{357     StaticLogInfo\& info = bgLogInfos[header-\/>logId];}
\DoxyCodeLine{358     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* data = (\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)(header + 1);}
\DoxyCodeLine{359     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* end = (\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)header + header-\/>size;}
\DoxyCodeLine{360     int64\_t tsc = *(int64\_t*)data;}
\DoxyCodeLine{361     data += 8;}
\DoxyCodeLine{362     \textcolor{keywordflow}{if} (!info.formatToFn) \{ \textcolor{comment}{// log once}}
\DoxyCodeLine{363       info.location = *(\textcolor{keyword}{const} \textcolor{keywordtype}{char}**)data;}
\DoxyCodeLine{364       data += 8;}
\DoxyCodeLine{365       info.processLocation();}
\DoxyCodeLine{366     \}}
\DoxyCodeLine{367     int64\_t ts = \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.tscns.tsc2ns(tsc);}
\DoxyCodeLine{368     \textcolor{comment}{// the date could go back when polling different threads}}
\DoxyCodeLine{369     uint64\_t t = (ts > midnightNs) ? (ts -\/ midnightNs) : 0;}
\DoxyCodeLine{370     nanosecond.fromi(t \% 1000000000);}
\DoxyCodeLine{371     t /= 1000000000;}
\DoxyCodeLine{372     second.fromi(t \% 60);}
\DoxyCodeLine{373     t /= 60;}
\DoxyCodeLine{374     minute.fromi(t \% 60);}
\DoxyCodeLine{375     t /= 60;}
\DoxyCodeLine{376     uint32\_t h = t; \textcolor{comment}{// hour}}
\DoxyCodeLine{377     \textcolor{keywordflow}{if} (h > 23) \{}
\DoxyCodeLine{378       h \%= 24;}
\DoxyCodeLine{379       resetDate();}
\DoxyCodeLine{380     \}}
\DoxyCodeLine{381     hour.fromi(h);}
\DoxyCodeLine{382     setArgVal<14>(info.getBase());}
\DoxyCodeLine{383     setArgVal<15>(info.getLocation());}
\DoxyCodeLine{384     logLevel = (\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)\textcolor{stringliteral}{"{}DBG INF WRN ERR OFF"{}} + (info.logLevel << 2);}
\DoxyCodeLine{385 }
\DoxyCodeLine{386     \textcolor{keywordtype}{size\_t} headerPos = membuf.size();}
\DoxyCodeLine{387     fmtlog::vformat\_to(membuf, headerPattern, fmt::basic\_format\_args(args.data(), parttenArgSize));}
\DoxyCodeLine{388     \textcolor{keywordtype}{size\_t} bodyPos = membuf.size();}
\DoxyCodeLine{389 }
\DoxyCodeLine{390     \textcolor{keywordflow}{if} (info.formatToFn) \{}
\DoxyCodeLine{391       info.formatToFn(info.formatString, data, membuf, info.argIdx, args);}
\DoxyCodeLine{392     \}}
\DoxyCodeLine{393     \textcolor{keywordflow}{else} \{ \textcolor{comment}{// log once}}
\DoxyCodeLine{394       membuf.append(fmt::string\_view(data, end -\/ data));}
\DoxyCodeLine{395     \}}
\DoxyCodeLine{396 }
\DoxyCodeLine{397     \textcolor{keywordflow}{if} (logCB \&\& info.logLevel >= minCBLogLevel) \{}
\DoxyCodeLine{398       logCB(ts, info.logLevel, info.getLocation(), info.basePos, threadName,}
\DoxyCodeLine{399             fmt::string\_view(membuf.data() + headerPos, membuf.size() -\/ headerPos), bodyPos -\/ headerPos,}
\DoxyCodeLine{400             fpos + headerPos);}
\DoxyCodeLine{401     \}}
\DoxyCodeLine{402     membuf.push\_back(\textcolor{charliteral}{'\(\backslash\)n'});}
\DoxyCodeLine{403     \textcolor{keywordflow}{if} (membuf.size() >= flushBufSize || info.logLevel >= flushLogLevel) \{}
\DoxyCodeLine{404       flushLogFile();}
\DoxyCodeLine{405     \}}
\DoxyCodeLine{406   \}}
\DoxyCodeLine{407 }
\DoxyCodeLine{408   \textcolor{keywordtype}{void} adjustHeap(\textcolor{keywordtype}{size\_t} i) \{}
\DoxyCodeLine{409     \textcolor{keywordflow}{while} (\textcolor{keyword}{true}) \{}
\DoxyCodeLine{410       \textcolor{keywordtype}{size\_t} min\_i = i;}
\DoxyCodeLine{411       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} ch = i * 2 + 1, end = std::min(ch + 2, bgThreadBuffers.size()); ch < end; ch++) \{}
\DoxyCodeLine{412         \textcolor{keyword}{auto} h\_ch = bgThreadBuffers[ch].header;}
\DoxyCodeLine{413         \textcolor{keyword}{auto} h\_min = bgThreadBuffers[min\_i].header;}
\DoxyCodeLine{414         \textcolor{keywordflow}{if} (h\_ch \&\& (!h\_min || *(int64\_t*)(h\_ch + 1) < *(int64\_t*)(h\_min + 1))) min\_i = ch;}
\DoxyCodeLine{415       \}}
\DoxyCodeLine{416       \textcolor{keywordflow}{if} (min\_i == i) \textcolor{keywordflow}{break};}
\DoxyCodeLine{417       std::swap(bgThreadBuffers[i], bgThreadBuffers[min\_i]);}
\DoxyCodeLine{418       i = min\_i;}
\DoxyCodeLine{419     \}}
\DoxyCodeLine{420   \}}
\DoxyCodeLine{421 }
\DoxyCodeLine{422   \textcolor{keywordtype}{void} poll(\textcolor{keywordtype}{bool} forceFlush) \{}
\DoxyCodeLine{423     \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.tscns.calibrate();}
\DoxyCodeLine{424     int64\_t tsc = \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.tscns.rdtsc();}
\DoxyCodeLine{425     \textcolor{keywordflow}{if} (logInfos.size()) \{}
\DoxyCodeLine{426       std::unique\_lock<std::mutex> lock(logInfoMutex);}
\DoxyCodeLine{427       \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}\& info : logInfos) \{}
\DoxyCodeLine{428         info.processLocation();}
\DoxyCodeLine{429       \}}
\DoxyCodeLine{430       bgLogInfos.insert(bgLogInfos.end(), logInfos.begin(), logInfos.end());}
\DoxyCodeLine{431       logInfos.clear();}
\DoxyCodeLine{432     \}}
\DoxyCodeLine{433     \textcolor{keywordflow}{if} (threadBuffers.size()) \{}
\DoxyCodeLine{434       std::unique\_lock<std::mutex> lock(bufferMutex);}
\DoxyCodeLine{435       \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} tb : threadBuffers) \{}
\DoxyCodeLine{436         bgThreadBuffers.emplace\_back(tb);}
\DoxyCodeLine{437       \}}
\DoxyCodeLine{438       threadBuffers.clear();}
\DoxyCodeLine{439     \}}
\DoxyCodeLine{440 }
\DoxyCodeLine{441     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < bgThreadBuffers.size(); i++) \{}
\DoxyCodeLine{442       \textcolor{keyword}{auto}\& node = bgThreadBuffers[i];}
\DoxyCodeLine{443       \textcolor{keywordflow}{if} (node.header) \textcolor{keywordflow}{continue};}
\DoxyCodeLine{444       node.header = node.tb-\/>varq.front();}
\DoxyCodeLine{445       \textcolor{keywordflow}{if} (!node.header \&\& node.tb-\/>shouldDeallocate) \{}
\DoxyCodeLine{446         \textcolor{keyword}{delete} node.tb;}
\DoxyCodeLine{447         node = bgThreadBuffers.back();}
\DoxyCodeLine{448         bgThreadBuffers.pop\_back();}
\DoxyCodeLine{449         i-\/-\/;}
\DoxyCodeLine{450       \}}
\DoxyCodeLine{451     \}}
\DoxyCodeLine{452 }
\DoxyCodeLine{453     \textcolor{keywordflow}{if} (bgThreadBuffers.empty()) \textcolor{keywordflow}{return};}
\DoxyCodeLine{454 }
\DoxyCodeLine{455     \textcolor{comment}{// build heap}}
\DoxyCodeLine{456     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = bgThreadBuffers.size() / 2; i >= 0; i-\/-\/) \{}
\DoxyCodeLine{457       adjustHeap(i);}
\DoxyCodeLine{458     \}}
\DoxyCodeLine{459 }
\DoxyCodeLine{460     \textcolor{keywordflow}{while} (\textcolor{keyword}{true}) \{}
\DoxyCodeLine{461       \textcolor{keyword}{auto} h = bgThreadBuffers[0].header;}
\DoxyCodeLine{462       \textcolor{keywordflow}{if} (!h || h-\/>logId >= bgLogInfos.size() || *(int64\_t*)(h + 1) >= tsc) \textcolor{keywordflow}{break};}
\DoxyCodeLine{463       \textcolor{keyword}{auto} tb = bgThreadBuffers[0].tb;}
\DoxyCodeLine{464       handleLog(fmt::string\_view(tb-\/>name, tb-\/>nameSize), h);}
\DoxyCodeLine{465       tb-\/>varq.pop();}
\DoxyCodeLine{466       bgThreadBuffers[0].header = tb-\/>varq.front();}
\DoxyCodeLine{467       adjustHeap(0);}
\DoxyCodeLine{468     \}}
\DoxyCodeLine{469 }
\DoxyCodeLine{470     \textcolor{keywordflow}{if} (membuf.size() == 0) \textcolor{keywordflow}{return};}
\DoxyCodeLine{471     \textcolor{keywordflow}{if} (!manageFp || forceFlush) \{}
\DoxyCodeLine{472       flushLogFile();}
\DoxyCodeLine{473       \textcolor{keywordflow}{return};}
\DoxyCodeLine{474     \}}
\DoxyCodeLine{475     int64\_t now = \mbox{\hyperlink{structfmtlogWrapper}{fmtlogWrapper<>::impl}}.tscns.tsc2ns(tsc);}
\DoxyCodeLine{476     \textcolor{keywordflow}{if} (now > nextFlushTime) \{}
\DoxyCodeLine{477       flushLogFile();}
\DoxyCodeLine{478     \}}
\DoxyCodeLine{479     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (nextFlushTime == (std::numeric\_limits<int64\_t>::max)()) \{}
\DoxyCodeLine{480       nextFlushTime = now + flushDelay;}
\DoxyCodeLine{481     \}}
\DoxyCodeLine{482   \}}
\DoxyCodeLine{483 \};}
\DoxyCodeLine{484 }
\DoxyCodeLine{485 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{486 \textcolor{keyword}{thread\_local} \textcolor{keyword}{typename} \mbox{\hyperlink{classfmtlogDetailT_1_1ThreadBufferDestroyer}{fmtlogDetailT<\_>::ThreadBufferDestroyer}} \mbox{\hyperlink{classfmtlogDetailT}{fmtlogDetailT<\_>::sbc}};}
\DoxyCodeLine{487 }
\DoxyCodeLine{488 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_\_ = 0>}
\DoxyCodeLine{489 \textcolor{keyword}{struct }\mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper}}}
\DoxyCodeLine{490 \{ \textcolor{keyword}{static} \mbox{\hyperlink{classfmtlogDetailT}{fmtlogDetailT<>}} impl; \};}
\DoxyCodeLine{491 }
\DoxyCodeLine{492 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{493 \mbox{\hyperlink{classfmtlogDetailT}{fmtlogDetailT<>}} \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<\_>::impl}};}
\DoxyCodeLine{494 }
\DoxyCodeLine{495 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{496 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::registerLogInfo}}(uint32\_t\& logId, FormatToFn fn, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* location,}
\DoxyCodeLine{497                                  LogLevel level, fmt::string\_view fmtString) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{498   \textcolor{keyword}{auto}\& d = \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}};}
\DoxyCodeLine{499   std::lock\_guard<std::mutex> lock(d.logInfoMutex);}
\DoxyCodeLine{500   \textcolor{keywordflow}{if} (logId) \textcolor{keywordflow}{return};}
\DoxyCodeLine{501   logId = d.logInfos.size() + d.bgLogInfos.size();}
\DoxyCodeLine{502   d.logInfos.emplace\_back(fn, location, level, fmtString);}
\DoxyCodeLine{503 \}}
\DoxyCodeLine{504 }
\DoxyCodeLine{505 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{506 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::vformat\_to}}(fmtlog::MemoryBuffer\& out, fmt::string\_view fmt,}
\DoxyCodeLine{507                             fmt::format\_args args) \{}
\DoxyCodeLine{508   fmt::detail::vformat\_to(out, fmt, args);}
\DoxyCodeLine{509 \}}
\DoxyCodeLine{510 }
\DoxyCodeLine{511 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{512 \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::formatted\_size}}(fmt::string\_view fmt, fmt::format\_args args) \{}
\DoxyCodeLine{513   \textcolor{keyword}{auto} buf = fmt::detail::counting\_buffer<>();}
\DoxyCodeLine{514   fmt::detail::vformat\_to(buf, fmt, args);}
\DoxyCodeLine{515   \textcolor{keywordflow}{return} buf.count();}
\DoxyCodeLine{516 \}}
\DoxyCodeLine{517 }
\DoxyCodeLine{518 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{519 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::vformat\_to}}(\textcolor{keywordtype}{char}* out, fmt::string\_view fmt, fmt::format\_args args) \{}
\DoxyCodeLine{520   fmt::vformat\_to(out, fmt, args);}
\DoxyCodeLine{521 \}}
\DoxyCodeLine{522 }
\DoxyCodeLine{523 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{524 \textcolor{keyword}{typename} \mbox{\hyperlink{structfmtlogT_1_1SPSCVarQueueOPT_1_1MsgHeader}{fmtlogT<\_>::SPSCVarQueueOPT::MsgHeader}}* \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::allocMsg}}(uint32\_t size,}
\DoxyCodeLine{525                                                                       \textcolor{keywordtype}{bool} q\_full\_cb) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{526   \textcolor{keyword}{auto}\& d = \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}};}
\DoxyCodeLine{527   \textcolor{keywordflow}{if} (threadBuffer == \textcolor{keyword}{nullptr}) preallocate();}
\DoxyCodeLine{528   \textcolor{keyword}{auto} ret = threadBuffer-\/>varq.alloc(size);}
\DoxyCodeLine{529   \textcolor{keywordflow}{if} ((ret == \textcolor{keyword}{nullptr}) \& q\_full\_cb) d.logQFullCB(d.logQFullCBArg);}
\DoxyCodeLine{530   \textcolor{keywordflow}{return} ret;}
\DoxyCodeLine{531 \}}
\DoxyCodeLine{532 }
\DoxyCodeLine{533 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{534 \textcolor{keyword}{typename} \mbox{\hyperlink{structfmtlogT_1_1SPSCVarQueueOPT_1_1MsgHeader}{fmtlogT<\_>::SPSCVarQueueOPT::MsgHeader}}*}
\DoxyCodeLine{535 \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::SPSCVarQueueOPT::allocMsg}}(uint32\_t size) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{536   \textcolor{keywordflow}{return} alloc(size);}
\DoxyCodeLine{537 \}}
\DoxyCodeLine{538 }
\DoxyCodeLine{539 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{540 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::preallocate}}() noexcept \{}
\DoxyCodeLine{541   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.preallocate();}
\DoxyCodeLine{542 \}}
\DoxyCodeLine{543 }
\DoxyCodeLine{544 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{545 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setLogFile}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* filename, \textcolor{keywordtype}{bool} truncate) \{}
\DoxyCodeLine{546   \textcolor{keyword}{auto}\& d = \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}};}
\DoxyCodeLine{547   FILE* newFp = fopen(filename, truncate ? \textcolor{stringliteral}{"{}w"{}} : \textcolor{stringliteral}{"{}a"{}});}
\DoxyCodeLine{548   \textcolor{keywordflow}{if} (!newFp) \{}
\DoxyCodeLine{549     std::string err = fmt::format(\textcolor{stringliteral}{"{}Unable to open file: \{\}: \{\}"{}}, filename, strerror(errno));}
\DoxyCodeLine{550     fmt::detail::throw\_format\_error(err.c\_str());}
\DoxyCodeLine{551   \}}
\DoxyCodeLine{552   setbuf(newFp, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{553   d.fpos = ftell(newFp);}
\DoxyCodeLine{554 }
\DoxyCodeLine{555   closeLogFile();}
\DoxyCodeLine{556   d.outputFp = newFp;}
\DoxyCodeLine{557   d.manageFp = \textcolor{keyword}{true};}
\DoxyCodeLine{558 \}}
\DoxyCodeLine{559 }
\DoxyCodeLine{560 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{561 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setLogFile}}(FILE* fp, \textcolor{keywordtype}{bool} manageFp) \{}
\DoxyCodeLine{562   \textcolor{keyword}{auto}\& d = \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}};}
\DoxyCodeLine{563   closeLogFile();}
\DoxyCodeLine{564   \textcolor{keywordflow}{if} (manageFp) \{}
\DoxyCodeLine{565     setbuf(fp, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{566     d.fpos = ftell(fp);}
\DoxyCodeLine{567   \}}
\DoxyCodeLine{568   \textcolor{keywordflow}{else}}
\DoxyCodeLine{569     d.fpos = 0;}
\DoxyCodeLine{570   d.outputFp = fp;}
\DoxyCodeLine{571   d.manageFp = manageFp;}
\DoxyCodeLine{572 \}}
\DoxyCodeLine{573 }
\DoxyCodeLine{574 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{575 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setFlushDelay}}(int64\_t ns) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{576   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.flushDelay = ns;}
\DoxyCodeLine{577 \}}
\DoxyCodeLine{578 }
\DoxyCodeLine{579 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{580 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::flushOn}}(LogLevel flushLogLevel) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{581   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.flushLogLevel = flushLogLevel;}
\DoxyCodeLine{582 \}}
\DoxyCodeLine{583 }
\DoxyCodeLine{584 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{585 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setFlushBufSize}}(uint32\_t \mbox{\hyperlink{classbytes}{bytes}}) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{586   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.flushBufSize = \mbox{\hyperlink{classbytes}{bytes}};}
\DoxyCodeLine{587 \}}
\DoxyCodeLine{588 }
\DoxyCodeLine{589 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{590 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::closeLogFile}}() noexcept \{}
\DoxyCodeLine{591   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.closeLogFile();}
\DoxyCodeLine{592 \}}
\DoxyCodeLine{593 }
\DoxyCodeLine{594 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{595 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::poll}}(\textcolor{keywordtype}{bool} forceFlush) \{}
\DoxyCodeLine{596   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.poll(forceFlush);}
\DoxyCodeLine{597 \}}
\DoxyCodeLine{598 }
\DoxyCodeLine{599 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{600 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setThreadName}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* name) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{601   preallocate();}
\DoxyCodeLine{602   threadBuffer-\/>nameSize = fmt::format\_to\_n(threadBuffer-\/>name, \textcolor{keyword}{sizeof}(fmtlog::threadBuffer-\/>name), \textcolor{stringliteral}{"{}\{\}"{}}, name).size;}
\DoxyCodeLine{603 \}}
\DoxyCodeLine{604 }
\DoxyCodeLine{605 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{606 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setLogCB}}(LogCBFn cb, LogLevel minCBLogLevel\_) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{607   \textcolor{keyword}{auto}\& d = \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}};}
\DoxyCodeLine{608   d.logCB = cb;}
\DoxyCodeLine{609   d.minCBLogLevel = minCBLogLevel\_;}
\DoxyCodeLine{610 \}}
\DoxyCodeLine{611 }
\DoxyCodeLine{612 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{613 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setLogQFullCB}}(LogQFullCBFn cb, \textcolor{keywordtype}{void}* userData) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{614   \textcolor{keyword}{auto}\& d = \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}};}
\DoxyCodeLine{615   d.logQFullCB = cb;}
\DoxyCodeLine{616   d.logQFullCBArg = userData;}
\DoxyCodeLine{617 \}}
\DoxyCodeLine{618 }
\DoxyCodeLine{619 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{620 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::setHeaderPattern}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* pattern) \{}
\DoxyCodeLine{621   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.setHeaderPattern(pattern);}
\DoxyCodeLine{622 \}}
\DoxyCodeLine{623 }
\DoxyCodeLine{624 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{625 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::startPollingThread}}(int64\_t pollInterval) \textcolor{keyword}{noexcept} \{}
\DoxyCodeLine{626   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.startPollingThread(pollInterval);}
\DoxyCodeLine{627 \}}
\DoxyCodeLine{628 }
\DoxyCodeLine{629 \textcolor{keyword}{template}<\textcolor{keywordtype}{int} \_>}
\DoxyCodeLine{630 \textcolor{keywordtype}{void} \mbox{\hyperlink{classfmtlogT}{fmtlogT<\_>::stopPollingThread}}() noexcept \{}
\DoxyCodeLine{631   \mbox{\hyperlink{structfmtlogDetailWrapper}{fmtlogDetailWrapper<>::impl}}.stopPollingThread();}
\DoxyCodeLine{632 \}}
\DoxyCodeLine{633 }
\DoxyCodeLine{634 \textcolor{keyword}{template} \textcolor{keyword}{class }\mbox{\hyperlink{classfmtlogT}{fmtlogT<0>}};}
\DoxyCodeLine{635 }

\end{DoxyCode}
